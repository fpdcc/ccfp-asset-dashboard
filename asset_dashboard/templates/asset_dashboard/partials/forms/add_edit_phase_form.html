{% extends "asset_dashboard/partials/project_base.html" %}
{% load static %}
{% load humanize %}

{% block extra_css %}
  <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
{% endblock %}

{% block project %}
<section class="m-2">
<div class="row">
  <div class="border border-secondary rounded shadow-sm col m-2 p-3 card">
  
    <form method="post">
      {% csrf_token %}
    
      {{ form.errors }}
  
      <div class="row col justify-content-between">
        <h3>{% if phase %}Update Phase{% else %}Create Phase{% endif %}</h3>
        <input type="submit" value="Save Phase" class="btn btn-info">
      </div>

      <div class="row my-4">
        <div class="col-2">
          <strong>Phase</strong>
          {{ form.phase_type }}
        </div>
        <div class="col-2">
          <strong>Status</strong>
          {{ form.status }}
        </div>
        <div class="col-2">
          <strong>Bid Quarter</strong>
          {{ form.estimated_bid_quarter }}
        </div>
        <div class="col-2">
          <strong>Year</strong>
          {{ form.year }}
        </div>
        <div class="col-2">
          <strong>Estimated Cost</strong>
          {{ form.total_estimated_cost }}
        </div>
        <div class="col-2" id='actualCost'>
          <strong>Actual Cost</strong>
          {{ form.actual_cost }}
        </div>
      </div>
    </form>
  </div>
</div>

<div class="row">
  <div class="col border border-secondary rounded shadow-sm p-3 m-2 card">
    <h3>Phase Funding</h3>
    {% if funding_streams %}
      <div class="d-flex justify-content-between m-3">
        <p class="lead"><strong>Total Funding:</strong> ${{ phase.total_budget|intcomma }}</p>
        <a href="{% url 'create-funding' pk=phase.id %}" class="text-info lead">Add funding ></a>
      </div>
      <table class="table table-hover table-border py-4">
        <thead>
          <tr>
            <th>Year</th>
            <th>Funds</th>
            <th>Source</th>
            <th>Secured</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for funding in funding_streams %}
          <tr>
            <td>{{ funding.year }}</td>
            <td>{{ funding.budget }}</td>
            <td>{{ funding.get_source_type_display }}</td>
            <td>{{ funding.funding_secured }}</td>
            <td><a href="{% url 'update-funding' pk=funding.id %}" class="text-info lead">Edit</a></td>
            <td style="width: 12%;"><a href="{% url 'delete-funding' pk=phase.id %}" class='btn btn-sm btn-outline-danger'><i class='fas fa-trash'></i> Delete</a>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>
        {% if phase and not funding_stream %}
          This phase has no funding. <a href="{% url 'create-funding' pk=phase.id %}" class="text-info lead">Add funding ></a>
        {% else %}
          Create the phase so you can add funding.
        {% endif %}
      </p>
    {% endif %}
  </div>
</div>


<div class="row">
  <div class="col border border-secondary rounded shadow-sm p-3 m-2 card">
    {% if not props %}
      <h3>Phase Assets</h3>
      <div>
        <p>
          {% if phase and not props %}
            This phase has no GIS assets. &nbsp;<a href="{% url 'create-update-assets' pk=phase.id %}" class="text-info lead">Add Assets ></a>
          {% elif not phase and not props %}
            Create the phase so you can add GIS assets.
          {% else %}
            <a href="{% url 'create-update-assets' pk=phase.id %}" class="text-info lead">Edit Assets ></a>
          {% endif %}
        </p>
      </div>
    {% else %}
      <div id="map" class="mt-2">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script type="text/javascript">
  const statusInput = document.getElementById('id_status')
  const actualCost = document.getElementById('actualCost')
  
  statusInput.addEventListener('change', function() {
    if (statusInput.value == 'complete') {
      <!-- if they're trying to update the phase actual cost once it's "complete", then turn of the year validation. -->
      document.getElementById('id_year').removeAttribute('min')
    }
  })
</script>
</section
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  {% load compress %}
  {{ props|json_script:"props" }}
  <script type="text/javascript">
    window.props = JSON.parse(document.getElementById('props').textContent)
    window.reactMount = document.getElementById('map')
  </script>
  {% compress js %}
    <script type="text/jsx" src="{% static 'js/components/maps/ListAssetsMap.js' %}"></script>
  {% endcompress %}
{% endblock %}
